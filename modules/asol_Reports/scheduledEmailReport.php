<?phpif(!defined('sugarEntry') || !sugarEntry) die('Not A Valid Entry Point');error_reporting(1); //E_ERROR global $current_user, $mod_strings, $sugar_config, $theme, $db;$asolReportsResizableNVD3Charts = ((isset($sugar_config['asolReportsResizableNVD3Charts'])) && ($sugar_config['asolReportsResizableNVD3Charts']));require_once('modules/asol_Reports/include_basic/reportsUtils.php');require_once('modules/asol_Reports/include_basic/generateReportsFunctions.php');require_once('modules/asol_Reports/include_basic/ReportChart.php');require_once('modules/asol_Reports/ReportsDashletChart.php');$availableReport = false;$isDashlet = (isset($_REQUEST['dashlet'])) ? true : false;$dashletId = (isset($_REQUEST['dashletId'])) ? $_REQUEST['dashletId'] : "";//**************************////***Is Domains Installed***////**************************//$domainsQuery = $db->query("SELECT * FROM upgrade_history WHERE id_name='AlineaSolDomains' AND status='installed'");$isDomainsInstalled = ($domainsQuery->num_rows > 0);//**************************////***Is Domains Installed***////**************************//if ($isDomainsInstalled) {		$reportCssfile = (is_file("modules/asol_Reports/include_basic/css/".$current_user->asol_default_domain.".css")) ? $current_user->asol_default_domain.".css" : 'reports.css';	} else {		$reportCssfile = 'reports.css';	}//Is Domains Installed$storedReportInfo = $_REQUEST['storedReportInfo'];if ($storedReportInfo === 'false') {		$availableReport = false;	} else {	$tmpReportFilesPath = 'modules/asol_Reports/tmpReportFiles/';			$storedReportData = unserialize(base64_decode($storedReportInfo));		$accessKey = (($isDomainsInstalled) && (isset($current_user->asol_default_domain))) ? $current_user->asol_default_domain : 'base';		$exportedReportFile = $storedReportData[$accessKey]['infoTxt'];	$reportCharts = $storedReportData[$accessKey]['chartFiles'];		if ((empty($exportedReportFile)) || (!is_file($tmpReportFilesPath.$exportedReportFile))) {				$availableReport = false;			} else {			$descriptor = @fopen($tmpReportFilesPath.$exportedReportFile, "r");			$serializedReport = fread($descriptor, filesize($tmpReportFilesPath.$exportedReportFile));		$report = unserialize($serializedReport);		fclose($descriptor);		$availableReport = true;				$report_data['record'] = $report['id'];		$report_name = $report['reportName'];				$report_data['report_charts'] = $report['report_charts'];		$report_charts_engine = $report_data['report_charts_engine'] = $report['report_charts_engine'];		$report_data['report_attachment_format'] = $report['report_attachment_format'];				$report_data['email_list'] = $report['email_list'];				$scheduled_images = $report['scheduled_images'];		$report_data['row_index_display'] = $report['row_index_display'];		$results_limit = $report['results_limit'];				$pdf_img_scaling_factor = $report['pdf_img_scaling_factor'];		$columns = $report['headers'];		$isDetailedReport = $report['isDetailedReport'];		$hasDisplayedCharts = $report['hasDisplayedCharts'];				$reportFields = $report['resultset'];		$subTotals = $report['subTotals'];		$totals = $report['headersTotals'];		$rsTotals = $report['totals'];							//************************//		//****Get Email Arrays****//		//************************//		$sendEmailquestion = asol_ReportsGenerationFunctions::getSendEmailAlert($report_data['email_list']);		//************************//		//****Get Email Arrays****//		//************************//								$data['num_pages'] = 0;		$data['page_number'] = 0;		$data['page_number_label'] = '1';		$data['num_pages_label'] = '1';		$data['total_entries'] = 1;						if (isset($_REQUEST['png'])) {						$filename = time().'.png';			$somecontent = base64_decode($_REQUEST['png']);					if ($handle = fopen($tmpReportFilesPath.$filename, 'w')){								if (!fwrite($handle, $somecontent) === FALSE)					fclose($handle);							ob_clean();								setcookie("fileDownloadToken", "token"); // blockUI								header("Content-type: image/png");				header("Content-Disposition: attachment; filename=\"".$filename."\"");				header("Content-Transfer-Encoding: binary");				header("Content-Length: ".filesize($tmpReportFilesPath.$filename));						readfile($tmpReportFilesPath.$filename); 							}						//Cabeceras y obtener el fichero						}				?>						<html>				<head>				<?php				if (!$isDashlet) {						if ($report_data['report_charts'] != "Tabl") {						$chartEngineLibraries = asol_ReportsCharts::getChartEngineLibraries($report_data['report_charts_engine'], false);					foreach ($chartEngineLibraries as $chartEngineLibrary) {						$library = explode(";", $chartEngineLibrary);						if ($library[0] == 'JS')							echo '<script type="text/javascript" src="'.$library[1].'"></script>';						else if ($library[0] == 'CSS')							echo '<link rel="stylesheet" type="text/css" href="'.$library[1].'">';					}									}											echo '<script type="text/javascript" src="cache/include/javascript/sugar_grp1_yui.js?version='.str_replace('.', '', asol_ReportsUtils::$reports_version).'"></script>';				echo '<script type="text/javascript" src="cache/include/javascript/sugar_grp1.js?version='.str_replace('.', '', asol_ReportsUtils::$reports_version).'"></script>';				echo '<script type="text/javascript" src="modules/asol_Reports/include_basic/js/reports.min.js?version='.str_replace('.', '', asol_ReportsUtils::$reports_version).'"></script>';				echo '<link rel="stylesheet" type="text/css" href="modules/asol_Reports/include_basic/css/style.css?version='.str_replace('.', '', asol_ReportsUtils::$reports_version).'">';						}						?>					<script type="text/javascript">				function setScheduledCharts() {					<?php 						$urlChart = array();			$html5Chart = array();			$nvd3Chart = array();							foreach ($reportCharts as $key=>$reportChart) {								if ($report_data['report_charts_engine'] == 'flash') { //Flash 							?>									var flashvars = {};					<?php echo 'flashvars.inputFile = "'.$reportChart['file'].'"'; ?>   					flashvars.swfLocation = "include/SugarCharts/swf/";										<?php 						if (file_exists("themes/default/images/sugarColors.xml")) 							echo 'flashvars.inputColorScheme = "themes/default/images/sugarColors.xml";';						else 							echo 'flashvars.inputColorScheme = "themes/'.$theme.'/images/sugarColors.xml";';					?>										flashvars.c = "1";										<?php						if (file_exists("cache/themes/Sugar/css/chart.css")) 							echo 'flashvars.inputStyleSheet = "themes/default/css/chart.css";';						else 							echo 'flashvars.inputStyleSheet = "themes/'.$theme.'/css/chart.css";';					?>										flashvars.inputLanguage = "modules/asol_Reports/language/chart_strings.en_us.lang.xml";					<?php											$w = 600;						$h = 400;												if ($reportChart['type'] == 'BarChart')				        	$w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*65) : $w;				        					        if ($reportChart['type'] == 'LineChart')				        	$w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*85) : $w;				        					        if ($reportChart['type'] == 'StackChart')				        	$w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*85) : $w;				        				        if ($reportChart['type'] == 'HorizontalChart')				        	$h = ($reportChart['subGroups'] > $h/100) ? $h + ((($reportChart['subGroups']) -($h/100))*25) : $h;				        					        					        $w = ($isDashlet) ? '100%' : $w;						        echo 'flashvars.myWidth = "'.$w.'";';				        echo 'flashvars.myHeight = "'.$h.'";';				        				        ?> 										var params = {};					params.quality = "high";					params.wmode = "transparent";					params.menu = "false";					params.allowscriptaccess = "always";								var attributes = {};										<?php 							echo 'swfobject.embedSWF("include/SugarCharts/swf/ASOLchart.swf", "ASOLflash_'.str_replace("-", "", $report_data['record']).'_'.$key.'", "'.$w.'", "'.$h.'", "10.0.0", "", flashvars, params, attributes);'; 													} else if ($report_data['report_charts_engine'] == 'html5') { //HTML5										$reportType = explode(':', $report['report_type']);					$isStoredReport = ($reportType[0] == 'stored') ? true : false;					$tmpFilesDir = ($isStoredReport) ? "modules/asol_Reports/tmpReportFiles/storedReports/" : "modules/asol_Reports/tmpReportFiles/";										$fileIdArray = explode("/", $reportChart['file']);					$fileIdArray2 = explode(".", $fileIdArray[count($fileIdArray)-1]);					$fileId = $fileIdArray2[0];							$chartType = ($reportChart['type'] == 'PieChart') ? "pieChart" : "barChart";					$chartParamType = ($reportChart['type'] == 'PieChart') ? "pieType" : "barType";					$chartComplex = (in_array($reportChart['type'], array('StackChart', 'HorizontalChart', 'LineChart'))) ? "stacked" : "basic";										if ($reportChart['type'] == 'HorizontalChart')						$chartOrientation = 'chartConfig["orientation"] = "horizontal";';					else if ($reportChart['type'] == 'StackChart')						$chartOrientation = 'chartConfig["orientation"] = "vertical";';					else						$chartOrientation = '';							if ($reportChart['type'] == 'PieChart')						$chartTypeHtml5 = "pie chart";					if ($reportChart['type'] == 'BarChart')						$chartTypeHtml5 = "bar chart";					if ($reportChart['type'] == 'StackChart')						$chartTypeHtml5 = "stacked group by chart";					if ($reportChart['type'] == 'HorizontalChart')						$chartTypeHtml5 = "horizontal group by chart";					if ($reportChart['type'] == 'LineChart')						$chartTypeHtml5 = "line chart";					if ($reportChart['type'] == 'FunnelChart')						$chartTypeHtml5 = "funnel chart 3D";																		$w = 600;					$h = 400;													if ($reportChart['type'] == 'BarChart')				       	$w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*50) : $w;				        					    if ($reportChart['type'] == 'LineChart')					    $w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*50) : $w;				       					    if ($reportChart['type'] == 'StackChart')				       	$w = ($reportChart['subGroups'] > $w/100) ? $w + ((($reportChart['subGroups']) -($w/100))*50) : $w;				        					    if ($reportChart['type'] == 'HorizontalChart')				       	$h = ($reportChart['subGroups'] > $h/100) ? $h + ((($reportChart['subGroups']) -($h/100))*50) : $h;										    $chart = new ReportsDashletChart($fileId);		  				    $w = ($isDashlet) ? '100%' : $w."px";							        					$html5Chart[] = array(						"html" => $chart->display("", "", $reportChart['file'], $chartTypeHtml5, "100%", $h),						"id" => $fileId,						"dimensions" => array(							"width" => $w,							"height" => $h						)					);																				echo 'SUGAR.util.doWhen("((SUGAR && SUGAR.mySugar && SUGAR.mySugar.sugarCharts) || SUGAR.loadChart || document.getElementById(\'showHideChartButton\') != null) && typeof(loadSugarChart) != undefined",						function() {							var css = new Array();							var chartConfig = new Array();							css["gridLineColor"] = "#cccccc";							css["font-family"] = "Arial";							css["color"] = "#000000";							'.$chartOrientation.'							chartConfig["'.$chartParamType.'"] = "'.$chartComplex.'";							chartConfig["tip"] = "name";							chartConfig["chartType"] = "'.$chartType.'";							chartConfig["imageExportType"] = "png";							loadCustomChartForReports = function(){								loadSugarChart("'.$fileId.'","'.$tmpFilesDir.$fileId.'.js",css,chartConfig);							};							loadCustomChartForReports();						}					);';								} else if ($report_data['report_charts_engine'] == 'nvd3') { //NVD3							$w = 600;					$h = 400;										if (in_array($reportChart['type'], array('BarChart', 'LineChart', 'ScatterChart', 'StackChart', 'AreaChart', 'BubbleChart')))			        	$w = ($reportChart['subGroups'] > $w/100) ? $w + (($reportChart['subGroups'] -($w/100))*25) : $w;			        				        if ($reportChart['type'] == 'HorizontalChart')			        	$h = ($reportChart['subGroups'] > $h/100) ? $h + (($reportChart['subGroups'] -($h/100))*20) : $h;				        				        $w = ($isDashlet) ? '100%' : $w."px";				        					$nvd3Chart[] = array(						"html" => "<div id='ASOLnvd3Title_".str_replace("-", "", $report_data['record'])."_".$key."'></div>",						"dimensions" => array(							"width" => $w,							"height" => $h						)					);											echo '						var script_'.str_replace("-", "", $report_data['record']).'_'.$key.' = document.createElement("script");					    script_'.str_replace("-", "", $report_data['record']).'_'.$key.'.type = "text/javascript";					    script_'.str_replace("-", "", $report_data['record']).'_'.$key.'.src = "'.$reportChart['file'].'";					    document.getElementById("ASOLnvd3_'.str_replace("-", "", str_replace("-", "", $report_data['record'])).'_'.$key.'").appendChild(script_'.str_replace("-", "", $report_data['record']).'_'.$key.');';							if ((!$isDashlet) && ($asolReportsResizableNVD3Charts))					    echo '$("#ASOLnvd3_'.str_replace("-", "", $report_data['record']).'_'.$key.'").resizable({ alsoResize: "#ASOLsvg_'.str_replace("-", "", $report_data['record']).'_'.$key.'" });';															}					$urlChart[] = $reportChart['file'];							}				?>			}					if (typeof jQuery === "undefined") {					    var script_tag = document.createElement("script");		    script_tag.setAttribute("type","text/javascript");		    script_tag.setAttribute("src", "modules/asol_Reports/include_basic/js/jquery.min.js");		   		    script_tag.onload = setScheduledCharts; //Run main() once jQuery has loaded		 		document.getElementsByTagName("head")[0].appendChild(script_tag);	 	} else {	 		setScheduledCharts();	 	}						</script>				<?php				if ($report['report_type'] == 'scheduled') {			echo '<link href="modules/asol_Reports/include_basic/css/'.$reportCssfile.'" type="text/css" rel="stylesheet">';			echo '<link href="cache/themes/Sugar5/css/style.css" type="text/css" rel="stylesheet">';		}				?>				</head>				<?php	}	}//***********************************************////**************Display Report*******************////***********************************************//$justDisplay = true;$filtersHiddenInputs = false;$scheduledEmailHideButtons = true;$chartSubGroupsValues = array();if ($availableReport) {		$noDataReport = ((empty($reportCharts)) && (empty($reportFields)));		if ($noDataReport && $isDashlet) {				echo '		<div id="reportDiv" class="alineasol_reports">		<table id="reportTable" style="width: 100%">			<tbody>				<tr>					<td><em>'.$mod_strings['LBL_REPORT_NO_RESULTS'].'</em></td>				</tr>			</tbody>		</table>		</div>';			} else {			include "modules/asol_Reports/include_basic/DetailViewHttpSave.php";	}	} else {		echo '	<div id="reportDiv" class="alineasol_reports">	<table id="reportTable" style="width: 100%">		<tbody>			<tr>				<td><em>'.$mod_strings['LBL_REPORT_NOT_AVAILABLE'].'</em></td>			</tr>		</tbody>	</table>	</div>';	}//***********************************************////**************Display Report*******************////***********************************************//?>